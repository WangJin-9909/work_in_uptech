/*      Framebuffer Video Capture Testing Tool
 *
 *      For testing a Video for Linux Two video capture driver
 *
 *      This program was written by Olivier Carmona, based on Bill Dirks.
 *      This program is in the public domain.
 *
 */
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <sys/time.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <fcntl.h>
#include <linux/fb.h>
#include <stdio.h>
#include <sys/mman.h>
#include <errno.h>
#include <math.h>

#include <linux/fs.h>
#include <linux/kernel.h>
#include <linux/videodev.h>

#define FB_DEV0 	"/dev/fb0" /* Device Name */

char fb_device[] = FB_DEV0;

const char bmp_head800_480_16[] = {
0x42,0x4d,0x00,0x90,0x01,0x00,0x00,0x00,0x00,0x00,0x42,0x00,0x00,0x00,0x28,0x00,
0x00,0x00,0x20,0x03,0x00,0x00,0x20,0xfe,0xff,0xff,0x01,0x00,0x10,0x00,0x03,0x00,
0x00,0x00,0x00,0xB8,0x0B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0x00,0x00,0xe0,0x07,0x00,0x00,0x1f,0x00,
0x00,0x00
};

const char bmp_head800_480_32[] = {
0x42,
0x4d,0x36,0x70,0x17,0x00,0x00,0x00,0x00,0x00,0x36,0x00,0x00,0x00,0x28,0x00,0x00,
0x00,0x20,0x03,0x00,0x00,0x20,0xfe,0xff,0xff,0x01,0x00,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x70,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00
};

const char bmp_head1024_600_32[] = {
0x42,
0x4d,0x36,0x80,0x25,0x00,0x00,0x00,0x00,0x00,0x36,0x00,0x00,0x00,0x28,0x00,0x00,
0x00,0x00,0x04,0x00,0x00,0xb7,0xfd,0xff,0xff,0x01,0x00,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x80,0x25,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00
};

#define FB_800_480_16
//#define FB_800_480_32
//#define FB_1024_600_32
 
#if defined(FB_800_480_16)
#define FB_WIDTH        800 /* Default Width */
#define FB_HEIGHT       480 /* Default Height */
#define FB_BITS         2
#define BMP_HEAD        bmp_head800_480_16 
#elif defined(FB_800_480_32)
#define FB_WIDTH        800 /* Default Width */
#define FB_HEIGHT       480 /* Default Height */
#define FB_BITS    	4
#define BMP_HEAD        bmp_head800_480_32 

#elif defined(FB_1024_600_32)
#define FB_WIDTH        1024 /* Default Width */
#define FB_HEIGHT       600 /* Default Height */
#define FB_BITS    	4
#define BMP_HEAD        bmp_head1024_600_32 
#endif

static  char filename[30];
FILE *bmpFile;
static  int capframe = 0;

int main (int argc, char *argv[])
{
	int fd_fb;
	struct fb_var_screeninfo fbvar;
	struct fb_fix_screeninfo fbfix;
	char *frame_buffer;
	int y, format;
 
	fd_fb = open(fb_device, O_RDWR);
	if (fd_fb < 0)
	{
		perror("fbdev open");
		return 0;
	}
	memset(&fbvar, 0, sizeof(fbvar));
	memset(&fbfix, 0, sizeof(fbfix));
	ioctl(fd_fb, FBIOGET_VSCREENINFO, &fbvar);
	ioctl(fd_fb, FBIOGET_FSCREENINFO, &fbfix);
	
	printf("length = %ld, x_res = %ld,y_rey = %ld, pix = %ld\n", fbfix.line_length,fbvar.xres_virtual,fbvar.yres_virtual,fbvar.bits_per_pixel);

	frame_buffer = (char *) mmap(0, fbfix.smem_len, PROT_READ | PROT_WRITE,MAP_SHARED, fd_fb, 0);
	printf("BMP_HEAD_LEN = %d\n",sizeof(BMP_HEAD));
	
	for (;;)
	{
        	capframe++;
		sprintf(filename,"/mnt/nfs/0%d.bmp",capframe);
		bmpFile=fopen(filename, "w+");
		fwrite(BMP_HEAD,1,sizeof(BMP_HEAD),bmpFile);
		for(y=0;y < FB_HEIGHT;y++)
			fwrite(frame_buffer + y * FB_WIDTH * FB_BITS,1,FB_WIDTH * FB_BITS,bmpFile);
		sleep(1);
		fclose(bmpFile);
	}

	return 0;
}

